<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Badly</title>
  <meta name="theme-color" content="#202245">
  <link rel="icon" href="/favicon.png" type="image/png">
  <link rel="manifest" href="/manifest.json">
  <style>
    :root {
      color-scheme: light;
      --primary: #202245;
      --primary-light: #343674;
      --accent: #ffb703;
      --danger: #d62828;
      --bg: #f4f4f8;
      --surface: #ffffff;
      --text: #1f2333;
      --text-muted: #5c6075;
      --border: #d5d7e3;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    body.modal-open {
      overflow: hidden;
    }

    a {
      color: inherit;
    }

    .hidden {
      display: none !important;
    }

    #app {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px clamp(16px, 4vw, 32px);
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 600;
      font-size: 1.1rem;
    }

    .brand-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
    }

    .user-menu {
      position: relative;
    }

    .user-button {
      border: none;
      background: var(--primary);
      color: #fff;
      padding: 8px 16px;
      border-radius: 999px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background 0.2s ease;
    }

    .user-button:hover {
      background: var(--primary-light);
    }

    .indicator {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      font-size: 0.7rem;
    }

    .user-dropdown {
      position: absolute;
      right: 0;
      top: calc(100% + 6px);
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      min-width: 180px;
      box-shadow: 0 12px 32px rgba(17, 20, 52, 0.15);
      display: grid;
      gap: 12px;
      z-index: 20;
    }

    .user-dropdown strong {
      font-size: 0.95rem;
    }

    .user-dropdown button {
      padding: 8px;
      border-radius: 8px;
      border: 1px solid transparent;
      cursor: pointer;
      background: var(--border);
      font-weight: 600;
    }

    main {
      flex: 1;
      padding: clamp(16px, 6vw, 48px);
      max-width: 960px;
      width: 100%;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .sessions-list {
      display: grid;
      gap: 16px;
    }

    .session-card {
      background: var(--surface);
      border-radius: 16px;
      padding: 20px;
      border: 1px solid var(--border);
      display: grid;
      gap: 14px;
      box-shadow: 0 8px 20px rgba(13, 18, 47, 0.08);
    }

    .session-card header {
      display: flex;
      flex-wrap: wrap;
      row-gap: 6px;
      column-gap: 12px;
      align-items: center;
      justify-content: space-between;
    }

    .session-meta {
      display: grid;
      gap: 6px;
      color: var(--text-muted);
      font-size: 0.95rem;
    }

    .session-meta span {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .session-meta strong {
      color: var(--text);
    }

    .session-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .session-actions button {
      border: none;
      border-radius: 8px;
      padding: 10px 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.15s ease, opacity 0.15s ease;
    }

    .session-actions button:active {
      transform: scale(0.98);
    }

    .btn-primary {
      background: var(--primary);
      color: #fff;
    }

    .btn-secondary {
      background: var(--border);
      color: var(--text);
    }

    .btn-danger {
      background: var(--danger);
      color: #fff;
    }

    .btn-disabled {
      cursor: not-allowed;
      opacity: 0.6;
    }

    .session-summary {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: space-between;
      align-items: center;
    }

    .participants-line {
      color: var(--text-muted);
      font-size: 0.95rem;
    }

    .participants-line strong {
      color: var(--text);
    }

    .empty-state {
      text-align: center;
      padding: 80px 20px;
      color: var(--text-muted);
      border: 2px dashed var(--border);
      border-radius: 16px;
      background: rgba(255, 255, 255, 0.6);
    }

    .fab {
      position: fixed;
      right: 24px;
      bottom: 24px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: none;
      background: var(--accent);
      color: #1a1a1a;
      font-size: 2rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 16px 30px rgba(255, 183, 3, 0.4);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      z-index: 15;
    }

    .fab:hover {
      transform: translateY(-3px);
      box-shadow: 0 20px 36px rgba(255, 183, 3, 0.5);
    }

    .backdrop {
      position: fixed;
      inset: 0;
      background: rgba(12, 15, 37, 0.4);
      z-index: 30;
    }

    .modal {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      z-index: 40;
    }

    .modal-card {
      background: var(--surface);
      border-radius: 20px;
      padding: clamp(24px, 5vw, 36px);
      width: min(420px, 100%);
      box-shadow: 0 24px 48px rgba(12, 15, 37, 0.25);
      display: grid;
      gap: 18px;
      border: 1px solid var(--border);
    }

    .modal-card h1,
    .modal-card h2 {
      margin: 0;
      text-align: center;
    }

    .auth-logo {
      width: 80px;
      height: 80px;
      margin: 0 auto;
      border-radius: 16px;
      box-shadow: 0 12px 32px rgba(12, 15, 37, 0.2);
    }

    .auth-tabs {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      background: var(--bg);
      border-radius: 12px;
      padding: 4px;
      gap: 4px;
    }

    .auth-tabs button {
      border: none;
      border-radius: 8px;
      padding: 10px;
      font-weight: 600;
      cursor: pointer;
      background: transparent;
      transition: background 0.2s ease;
    }

    .auth-tabs button.active {
      background: var(--surface);
      box-shadow: 0 6px 16px rgba(12, 15, 37, 0.18);
    }

    form {
      display: grid;
      gap: 12px;
    }

    label {
      display: grid;
      gap: 6px;
      font-size: 0.9rem;
    }

    input,
    select {
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 1rem;
      background: #fff;
    }

    input:focus,
    select:focus {
      outline: 2px solid var(--primary-light);
      border-color: transparent;
    }

    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 8px;
    }

    .form-actions button {
      padding: 10px 18px;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      cursor: pointer;
    }

    .toast-container {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      top: 24px;
      display: grid;
      gap: 10px;
      z-index: 50;
      width: min(90%, 400px);
    }

    .toast {
      background: var(--surface);
      border-left: 4px solid var(--primary);
      padding: 12px 16px;
      border-radius: 12px;
      box-shadow: 0 16px 36px rgba(10, 12, 28, 0.18);
      transition: opacity 0.3s ease, transform 0.3s ease;
    }

    .toast.error {
      border-left-color: var(--danger);
    }

    .toast.fade-out {
      opacity: 0;
      transform: translateY(-12px);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--bg);
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .session-title {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .session-title span {
      color: var(--text-muted);
      font-size: 0.9rem;
      font-weight: 500;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      background: rgba(32, 34, 69, 0.08);
      color: var(--primary);
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.85rem;
    }

    @media (min-width: 720px) {
      .sessions-list {
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      }
    }

    @media (max-width: 600px) {
      .app-header {
        padding: 12px 16px;
      }
      .session-card {
        padding: 16px;
      }
      .fab {
        right: 16px;
        bottom: 16px;
      }
    }

    /* Install Prompt Styles */
    .install-prompt {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      z-index: 60;
      background: rgba(12, 15, 37, 0.5);
      backdrop-filter: blur(4px);
    }

    .install-prompt-card {
      background: var(--surface);
      border-radius: 20px;
      padding: clamp(24px, 5vw, 32px);
      width: min(480px, 100%);
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 24px 48px rgba(12, 15, 37, 0.3);
      border: 1px solid var(--border);
      display: grid;
      gap: 20px;
    }

    .install-prompt-header {
      display: grid;
      gap: 12px;
      text-align: center;
    }

    .install-prompt-header h2 {
      margin: 0;
      font-size: 1.5rem;
      color: var(--primary);
    }

    .install-prompt-header p {
      margin: 0;
      color: var(--text-muted);
      line-height: 1.5;
    }

    .install-instructions {
      background: var(--bg);
      border-radius: 12px;
      padding: 20px;
      display: grid;
      gap: 16px;
    }

    .install-step {
      display: flex;
      gap: 12px;
      align-items: flex-start;
    }

    .install-step-number {
      flex-shrink: 0;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--primary);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.9rem;
    }

    .install-step-text {
      flex: 1;
      line-height: 1.6;
      padding-top: 2px;
    }

    .install-step-text strong {
      color: var(--primary);
    }

    .install-icon {
      display: inline-block;
      padding: 2px 6px;
      background: rgba(32, 34, 69, 0.1);
      border-radius: 4px;
      font-weight: 600;
      color: var(--primary);
    }

    .install-prompt-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .install-prompt-actions button {
      padding: 12px 24px;
      border-radius: 10px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.15s ease;
    }

    .install-prompt-actions button:active {
      transform: scale(0.98);
    }

    .btn-dismiss {
      background: var(--border);
      color: var(--text);
    }

    .btn-understood {
      background: var(--primary);
      color: #fff;
    }
  </style>
</head>
<body>
  <div id="app">
    <header class="app-header">
      <div class="brand">
        <img src="/favicon.png" alt="Badly" class="brand-icon">
        <span>Badly</span>
      </div>
      <div class="user-menu">
        <button id="user-button" class="user-button hidden">
          <span id="user-button-label"></span>
          <span class="indicator">‚ñº</span>
        </button>
        <div id="user-dropdown" class="user-dropdown hidden">
          <strong id="user-name"></strong>
          <button id="signout-button" type="button">Se d√©connecter</button>
        </div>
      </div>
    </header>
    <main>
      <div id="sessions-empty" class="empty-state hidden">
        Aucune session √† venir pour le moment. Cliquez sur + pour en cr√©er une.
      </div>
      <div id="sessions-list" class="sessions-list"></div>
    </main>
    <button id="create-session-button" class="fab hidden" title="Cr√©er une session">+</button>
  </div>

  <div id="backdrop" class="backdrop hidden"></div>

  <div id="auth-modal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="modal-card">
      <img src="/favicon.png" alt="Badly" class="auth-logo">
      <h1>Badly<br><small>Le badminton √† Lyon !</small></h1>
      <div class="auth-tabs">
        <button type="button" data-mode="signin" class="active">Connexion</button>
        <button type="button" data-mode="signup">Inscription</button>
      </div>
      <form id="signin-form">
        <label>
          Nom d'utilisateur
          <input name="name" type="text" autocomplete="username" required minlength="3" maxlength="20" pattern="[A-Za-z0-9_-]+">
        </label>
        <label>
          Mot de passe
          <input name="password" type="password" autocomplete="current-password" required minlength="6">
        </label>
        <div class="form-actions">
          <button type="submit" class="btn-primary">Connexion</button>
        </div>
      </form>
      <form id="signup-form" class="hidden">
        <label>
          Nom d'utilisateur
          <input name="name" type="text" autocomplete="off" required minlength="3" maxlength="20" pattern="[A-Za-z0-9_-]+">
        </label>
        <label>
          Mot de passe
          <input name="password" type="password" autocomplete="new-password" required minlength="6" maxlength="64">
        </label>
        <label>
          Confirmation
          <input name="confirm" type="password" autocomplete="new-password" required minlength="6" maxlength="64">
        </label>
        <div class="form-actions">
          <button type="submit" class="btn-primary">Inscription</button>
        </div>
      </form>
    </div>
  </div>

  <div id="session-modal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="modal-card">
      <h2 id="session-modal-title">Nouvelle session</h2>
      <form id="session-form">
        <input type="hidden" name="sessionId" value="">
        <label>
          Club
          <select name="club" required></select>
        </label>
        <label>
          Date et heure
          <input name="datetime" type="datetime-local" required>
        </label>
        <label>
          Niveau des joueurs
          <select name="level" required>
            <option value="d√©butant">D√©butant</option>
            <option value="d√©butant/moyen">D√©butant/Moyen</option>
            <option value="moyen" selected>Moyen</option>
            <option value="confirm√©">Confirm√©</option>
          </select>
        </label>
        <label>
          Dur√©e
          <select name="duration" required>
            <option value="45">45 minutes</option>
            <option value="60">1 heure</option>
            <option value="90" selected>1 heure 30</option>
            <option value="120">2 heures</option>
          </select>
        </label>
        <label>
          Nombre de participants
          <select name="capacity" required>
            <option value="4">4 joueurs</option>
            <option value="8" selected>8 joueurs</option>
          </select>
        </label>
        <label>
          Prix par participant (EUR)
          <input name="price" type="number" min="0" max="200" step="0.5" value="8" required>
        </label>
        <div class="form-actions">
          <button type="button" id="session-cancel" class="btn-secondary">Annuler</button>
          <button type="button" id="session-delete" class="btn-danger hidden">Supprimer</button>
          <button type="submit" id="session-submit" class="btn-primary">Cr√©er</button>
        </div>
      </form>
    </div>
  </div>

  <div id="toast-container" class="toast-container"></div>

  <div id="install-prompt" class="install-prompt hidden">
    <div class="install-prompt-card">
      <div class="install-prompt-header">
        <h2>üì± Installez Badly sur votre t√©l√©phone</h2>
        <p>Acc√©dez rapidement √† l'application directement depuis votre √©cran d'accueil !</p>
      </div>
      <div class="install-instructions" id="install-instructions">
        <!-- Les instructions seront ins√©r√©es ici selon le type d'appareil -->
      </div>
      <div class="install-prompt-actions">
        <button type="button" id="install-dismiss" class="btn-dismiss">Plus tard</button>
        <button type="button" id="install-understood" class="btn-understood">J'ai compris !</button>
      </div>
    </div>
  </div>

  <script>
    const app = {
      state: {
        user: null,
        sessions: [],
        clubs: [],
        pushSubscription: null,
        vapidPublicKey: null
      },
      init() {
        this.cacheElements();
        this.bindEvents();
        this.restoreAuth();
        this.startAutoRefresh();
        this.registerServiceWorker();
      },
      startAutoRefresh() {
        setInterval(() => {
          if (this.state.user) {
            this.refreshSessions();
          }
        }, 60000);
      },
      cacheElements() {
        this.$authModal = document.getElementById('auth-modal');
        this.$sessionModal = document.getElementById('session-modal');
        this.$backdrop = document.getElementById('backdrop');
        this.$signinForm = document.getElementById('signin-form');
        this.$signupForm = document.getElementById('signup-form');
        this.$sessionForm = document.getElementById('session-form');
        this.$sessionCancel = document.getElementById('session-cancel');
        this.$sessionDelete = document.getElementById('session-delete');
        this.$sessionSubmit = document.getElementById('session-submit');
        this.$sessionModalTitle = document.getElementById('session-modal-title');
        this.$sessionsList = document.getElementById('sessions-list');
        this.$sessionsEmpty = document.getElementById('sessions-empty');
        this.$toastContainer = document.getElementById('toast-container');
        this.$createButton = document.getElementById('create-session-button');
        this.$userButton = document.getElementById('user-button');
        this.$userButtonLabel = document.getElementById('user-button-label');
        this.$userDropdown = document.getElementById('user-dropdown');
        this.$userName = document.getElementById('user-name');
        this.$signoutButton = document.getElementById('signout-button');
        this.$authTabs = this.$authModal.querySelectorAll('.auth-tabs button');
        this.$installPrompt = document.getElementById('install-prompt');
        this.$installInstructions = document.getElementById('install-instructions');
        this.$installDismiss = document.getElementById('install-dismiss');
        this.$installUnderstood = document.getElementById('install-understood');
        this.$main = document.querySelector('main');
        this.$header = document.querySelector('.app-header');
      },
      bindEvents() {
        document.addEventListener('click', (event) => {
          if (!this.$userDropdown) return;
          const isButton = event.target.closest('#user-button');
          const isDropdown = event.target.closest('#user-dropdown');
          if (isButton) {
            this.toggleDropdown();
          } else if (!isDropdown) {
            this.closeDropdown();
          }
        });

        this.$signoutButton.addEventListener('click', () => this.signout());
        this.$createButton.addEventListener('click', () => this.openSessionModal());
        this.$sessionCancel.addEventListener('click', () => this.closeSessionModal());
        this.$sessionDelete.addEventListener('click', () => this.deleteSessionFromModal());
        this.$backdrop.addEventListener('click', () => {
          if (!this.$sessionModal.classList.contains('hidden')) {
            this.closeSessionModal();
          }
        });

        this.$signinForm.addEventListener('submit', (event) => {
          event.preventDefault();
          const formData = new FormData(this.$signinForm);
          const name = formData.get('name').trim();
          const password = formData.get('password');
          if (!name || !password) {
            this.toast('Champs manquants', true);
            return;
          }
          this.signin({ name, password });
        });

        this.$signupForm.addEventListener('submit', (event) => {
          event.preventDefault();
          const formData = new FormData(this.$signupForm);
          const name = formData.get('name').trim();
          const password = formData.get('password');
          const confirm = formData.get('confirm');
          if (password !== confirm) {
            this.toast('Les mots de passe ne correspondent pas', true);
            return;
          }
          if (password.length < 6) {
            this.toast('Mot de passe trop court', true);
            return;
          }
          this.signup({ name, password });
        });

        this.$sessionForm.addEventListener('submit', (event) => {
          event.preventDefault();
          const formData = new FormData(this.$sessionForm);
          const sessionId = formData.get('sessionId');
          const club = formData.get('club');
          const datetimeValue = formData.get('datetime');
          const level = formData.get('level');
          const duration = Number(formData.get('duration'));
          const capacity = Number(formData.get('capacity'));
          const price = Number(formData.get('price'));

          if (!club || !datetimeValue) {
            this.toast('Merci de renseigner tous les champs', true);
            return;
          }

          const datetime = new Date(datetimeValue);
          if (Number.isNaN(datetime.getTime())) {
            this.toast('Date invalide', true);
            return;
          }

          // V√©rifier que l'heure est un multiple de 15 minutes
          const minutes = datetime.getMinutes();
          if (minutes % 15 !== 0) {
            this.toast('L\'heure doit √™tre un multiple de 15 minutes (ex: 9h00, 9h15, 9h30, 9h45)', true);
            return;
          }

          const payload = {
            club,
            datetime: datetime.toISOString(),
            level,
            durationMinutes: duration,
            capacity,
            pricePerParticipant: price
          };

          if (sessionId) {
            // Mode √©dition
            payload.sessionId = sessionId;
            this.editSession(payload);
          } else {
            // Mode cr√©ation
            this.createSession(payload);
          }
        });

        this.$authTabs.forEach((button) => {
          button.addEventListener('click', () => {
            this.$authTabs.forEach((tab) => tab.classList.toggle('active', tab === button));
            if (button.dataset.mode === 'signin') {
              this.$signinForm.classList.remove('hidden');
              this.$signupForm.classList.add('hidden');
            } else {
              this.$signinForm.classList.add('hidden');
              this.$signupForm.classList.remove('hidden');
            }
          });
        });

        this.$installDismiss.addEventListener('click', () => this.dismissInstallPrompt());
        this.$installUnderstood.addEventListener('click', () => this.dismissInstallPrompt(true));
      },
      async signup(credentials) {
        if (this._signingUp) return;
        this._signingUp = true;
        try {
          const response = await this.api('/signup', credentials);
          this.toast('Inscription r√©ussie');
          this.onAuthenticated(response.user);
        } catch (err) {
          this.toast(err.message, true);
        } finally {
          this._signingUp = false;
        }
      },
      async signin(credentials, silent = false) {
        if (this._signingIn) return;
        this._signingIn = true;
        try {
          const response = await this.api('/signin', credentials);
          if (!silent) {
            this.toast('Connexion r√©ussie');
          }
          this.onAuthenticated(response.user);
        } catch (err) {
          this.toast(err.message, true);
        } finally {
          this._signingIn = false;
        }
      },
      async signout() {
        try {
          await this.api('/signout', {});
        } catch (err) {
          // signout should not block even if request fails
        }
        document.cookie = 'badlyAuth=; Max-Age=0; path=/';
        document.cookie = 'badlyInstallPromptSeen=; Max-Age=0; path=/';
        this.state.user = null;
        this.state.sessions = [];
        this.renderSessions();
        this.updateUserMenu();
        this.showAuthModal();
        this.toggleFab();
        this.closeDropdown();
      },
      onAuthenticated(user) {
        this.state.user = {
          ...user,
          normalized: user.name.toLowerCase()
        };
        this.hideAuthModal();
        this.toggleFab();
        this.updateUserMenu();
        this.refreshSessions();
        this.checkInstallPrompt();
        this.setupPushNotifications();
      },
      toggleFab() {
        if (this.state.user) {
          this.$createButton.classList.remove('hidden');
        } else {
          this.$createButton.classList.add('hidden');
        }
      },
      updateUserMenu() {
        if (!this.state.user) {
          this.$userButton.classList.add('hidden');
          return;
        }
        this.$userButton.classList.remove('hidden');
        this.$userName.textContent = this.state.user.name;
        this.$userButtonLabel.textContent = this.state.user.name;
      },
      toggleDropdown() {
        this.$userDropdown.classList.toggle('hidden');
      },
      closeDropdown() {
        this.$userDropdown.classList.add('hidden');
      },
      openSessionModal(session = null) {
        if (!this.state.clubs.length) {
          this.toast('Aucun club r√©f√©renc√©. Ajoutez-en dans data.json.', true);
          return;
        }
        
        this.$sessionForm.reset();
        const select = this.$sessionForm.elements.namedItem('club');
        select.innerHTML = '';
        this.state.clubs.forEach((club) => {
          const option = document.createElement('option');
          option.value = club;
          option.textContent = club;
          select.appendChild(option);
        });

        if (session) {
          // Mode √©dition
          this.$sessionModalTitle.textContent = 'Modifier la session';
          this.$sessionSubmit.textContent = 'Enregistrer';
          this.$sessionDelete.classList.remove('hidden');
          
          // Remplir le formulaire avec les donn√©es de la session
          this.$sessionForm.elements.namedItem('sessionId').value = session.id;
          this.$sessionForm.elements.namedItem('club').value = session.club;
          this.$sessionForm.elements.namedItem('level').value = session.level;
          this.$sessionForm.elements.namedItem('duration').value = session.durationMinutes;
          this.$sessionForm.elements.namedItem('capacity').value = session.capacity;
          this.$sessionForm.elements.namedItem('price').value = session.pricePerParticipant;
          
          const sessionDate = new Date(session.datetime);
          const local = new Date(sessionDate.getTime() - sessionDate.getTimezoneOffset() * 60000);
          this.$sessionForm.elements.namedItem('datetime').value = local.toISOString().slice(0, 16);
        } else {
          // Mode cr√©ation
          this.$sessionModalTitle.textContent = 'Nouvelle session';
          this.$sessionSubmit.textContent = 'Cr√©er';
          this.$sessionDelete.classList.add('hidden');
          this.$sessionForm.elements.namedItem('sessionId').value = '';
          
          const datetimeInput = this.$sessionForm.elements.namedItem('datetime');
          const now = new Date();
          // Arrondir au prochain quart d'heure
          const minutes = now.getMinutes();
          const roundedMinutes = Math.ceil(minutes / 15) * 15;
          now.setMinutes(roundedMinutes);
          now.setSeconds(0);
          now.setMilliseconds(0);
          const local = new Date(now.getTime() - now.getTimezoneOffset() * 60000);
          datetimeInput.value = local.toISOString().slice(0, 16);
        }
        
        this.$sessionModal.classList.remove('hidden');
        this.$backdrop.classList.remove('hidden');
        document.body.classList.add('modal-open');
      },
      closeSessionModal() {
        this.$sessionModal.classList.add('hidden');
        this.$backdrop.classList.add('hidden');
        this.$sessionForm.reset();
        document.body.classList.remove('modal-open');
      },
      showAuthModal() {
        this.$authModal.classList.remove('hidden');
        this.$backdrop.classList.remove('hidden');
        this.$main.classList.add('hidden');
        this.$header.classList.add('hidden');
        document.body.classList.add('modal-open');
      },
      hideAuthModal() {
        this.$authModal.classList.add('hidden');
        this.$backdrop.classList.add('hidden');
        this.$main.classList.remove('hidden');
        this.$header.classList.remove('hidden');
        this.$signinForm.reset();
        this.$signupForm.reset();
        document.body.classList.remove('modal-open');
      },
      async refreshSessions() {
        try {
          const response = await this.api('/listSessions', null, { method: 'GET' });
          this.state.sessions = response.sessions || [];
          this.state.clubs = response.clubs || [];
          this.renderSessions();
        } catch (err) {
          this.toast(err.message, true);
        }
      },
      renderSessions() {
        const list = this.$sessionsList;
        list.innerHTML = '';
        if (!this.state.sessions.length) {
          this.$sessionsEmpty.classList.remove('hidden');
          return;
        }
        this.$sessionsEmpty.classList.add('hidden');
        const now = Date.now();
        const dateFormatter = new Intl.DateTimeFormat('fr-FR', { weekday: 'short', day: '2-digit', month: 'short' });
        const timeFormatter = new Intl.DateTimeFormat('fr-FR', { hour: '2-digit', minute: '2-digit' });
        this.state.sessions.forEach((session) => {
          const card = document.createElement('article');
          card.className = 'session-card';

          const sessionDate = new Date(session.datetime);
          const durationLabel = this.formatDuration(session.durationMinutes);
          const priceLabel = Number(session.pricePerParticipant) === 0 ? 'Gratuit' : new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(session.pricePerParticipant);
          const participants = Array.isArray(session.participants) ? session.participants : [];
          const participantCount = session.participantCount ?? (participants.length + 1);

          const header = document.createElement('header');
          header.innerHTML = `
            <div class="session-title">${session.club} <span>${dateFormatter.format(sessionDate)} ${timeFormatter.format(sessionDate)}</span></div>
            <span class="pill">${participantCount}/${session.capacity}</span>
          `;

          const meta = document.createElement('div');
          meta.className = 'session-meta';
          meta.innerHTML = `
            <span><strong>Organisateur :</strong> ${session.organizer}</span>
            ${session.level ? `<span><strong>Niveau :</strong> ${session.level}</span>` : ''}
            <span><strong>Dur√©e :</strong> ${durationLabel}</span>
            <span><strong>Tarif :</strong> ${priceLabel}</span>
          `;

          const participantsLine = document.createElement('div');
          participantsLine.className = 'participants-line';
          const others = participants.filter((name) => name !== session.organizer);
          const guestCount = session.guests || 0;
          let participantsText = others.length ? others.join(', ') : 'Aucun pour le moment';
          if (guestCount > 0) {
            participantsText += ` ${guestCount > 0 ? '+ ' + guestCount + ' invit√©' + (guestCount > 1 ? 's' : '') : ''}`;
          }
          participantsLine.innerHTML = `<strong>Participants :</strong> ${participantsText}`;

          // Ligne des int√©ress√©s (followers)
          const followers = session.followers || [];
          let followersLine = null;
          if (followers.length > 0) {
            followersLine = document.createElement('div');
            followersLine.className = 'participants-line';
            followersLine.innerHTML = `<strong>Int√©ress√©s :</strong> ${followers.length}`;
          }

          const actions = document.createElement('div');
          actions.className = 'session-actions';
          const isOrganizer = this.state.user && session.organizer === this.state.user.name;
          const isParticipant = this.state.user && participants.includes(this.state.user.name);
          const hasStarted = sessionDate.getTime() <= now;
          const isFull = participantCount >= session.capacity;
          const currentGuests = session.guests || 0;

          if (this.state.user && !isOrganizer && !hasStarted) {
            if (isParticipant) {
              const leaveBtn = document.createElement('button');
              leaveBtn.className = 'btn-secondary';
              leaveBtn.textContent = 'Quitter';
              leaveBtn.addEventListener('click', () => this.leaveSession(session.id));
              actions.appendChild(leaveBtn);
            } else {
              const joinBtn = document.createElement('button');
              joinBtn.className = 'btn-primary';
              joinBtn.textContent = isFull ? 'Session pleine' : 'Rejoindre';
              if (isFull) {
                joinBtn.disabled = true;
                joinBtn.classList.add('btn-disabled');
              } else {
                joinBtn.addEventListener('click', () => this.joinSession(session.id));
              }
              actions.appendChild(joinBtn);
            }

            // Bouton Suivre / Ne plus suivre
            const followers = session.followers || [];
            const isFollowing = followers.includes(this.state.user.name);
            const followBtn = document.createElement('button');
            followBtn.className = isFollowing ? 'btn-secondary' : 'btn-primary';
            followBtn.textContent = isFollowing ? 'Ne plus suivre' : 'Suivre';
            followBtn.addEventListener('click', () => {
              if (isFollowing) {
                this.unfollowSession(session.id);
              } else {
                this.followSession(session.id);
              }
            });
            actions.appendChild(followBtn);
          }

          if (this.state.user && isOrganizer && !hasStarted) {
            const editBtn = document.createElement('button');
            editBtn.className = 'btn-primary';
            editBtn.textContent = 'Modifier';
            editBtn.addEventListener('click', () => this.openSessionModal(session));
            actions.appendChild(editBtn);
          }

          if (this.state.user && isOrganizer && !hasStarted) {
            if (!isFull) {
              const addGuestBtn = document.createElement('button');
              addGuestBtn.className = 'btn-primary';
              addGuestBtn.textContent = '+1 Invit√©';
              addGuestBtn.addEventListener('click', () => this.addGuest(session.id));
              actions.appendChild(addGuestBtn);
            }

            if (currentGuests > 0) {
              const removeGuestBtn = document.createElement('button');
              removeGuestBtn.className = 'btn-primary';
              removeGuestBtn.textContent = '-1 Invit√©';
              removeGuestBtn.addEventListener('click', () => this.removeGuest(session.id));
              actions.appendChild(removeGuestBtn);
            }
          }

          if (hasStarted && !actions.children.length) {
            const info = document.createElement('span');
            info.className = 'badge';
            info.textContent = 'Session d√©marr√©e';
            actions.appendChild(info);
          }

          card.appendChild(header);
          card.appendChild(meta);
          if (followersLine) {
            card.appendChild(followersLine);
          }
          card.appendChild(participantsLine);
          card.appendChild(actions);
          list.appendChild(card);
        });
      },
      formatDuration(minutes) {
        const total = Number(minutes) || 0;
        const hours = Math.floor(total / 60);
        const mins = total % 60;
        if (hours && mins) return `${hours} h ${mins} min`;
        if (hours) return `${hours} h`;
        return `${mins} min`;
      },
      async createSession(payload) {
        try {
          await this.api('/createSession', payload);
          this.toast('Session cr√©√©e');
          this.closeSessionModal();
          this.refreshSessions();
        } catch (err) {
          this.toast(err.message, true);
        }
      },
      async editSession(payload) {
        try {
          await this.api('/editSession', payload);
          this.toast('Session modifi√©e');
          this.closeSessionModal();
          this.refreshSessions();
        } catch (err) {
          this.toast(err.message, true);
        }
      },
      async deleteSessionFromModal() {
        const sessionId = this.$sessionForm.elements.namedItem('sessionId').value;
        if (!sessionId) return;
        
        if (!confirm('Supprimer cette session ?')) return;
        
        try {
          await this.api('/deleteSession', { sessionId });
          this.toast('Session supprim√©e');
          this.closeSessionModal();
          this.refreshSessions();
        } catch (err) {
          this.toast(err.message, true);
        }
      },
      async deleteSession(sessionId) {
        if (!confirm('Supprimer cette session ?')) return;
        try {
          await this.api('/deleteSession', { sessionId });
          this.toast('Session supprim√©e');
          this.refreshSessions();
        } catch (err) {
          this.toast(err.message, true);
        }
      },
      async joinSession(sessionId) {
        try {
          await this.api('/joinSession', { sessionId });
          this.toast('Inscription enregistr√©e');
          this.refreshSessions();
        } catch (err) {
          this.toast(err.message, true);
        }
      },
      async leaveSession(sessionId) {
        try {
          await this.api('/leaveSession', { sessionId });
          this.toast('D√©sinscription enregistr√©e');
          this.refreshSessions();
        } catch (err) {
          this.toast(err.message, true);
        }
      },
      async addGuest(sessionId) {
        try {
          await this.api('/addGuest', { sessionId });
          this.toast('Invit√© ajout√©');
          this.refreshSessions();
        } catch (err) {
          this.toast(err.message, true);
        }
      },
      async removeGuest(sessionId) {
        try {
          await this.api('/removeGuest', { sessionId });
          this.toast('Invit√© retir√©');
          this.refreshSessions();
        } catch (err) {
          this.toast(err.message, true);
        }
      },
      async followSession(sessionId) {
        try {
          await this.api('/followSession', { sessionId });
          this.toast('Vous suivez maintenant cette session. Vous recevrez toutes les notifications.');
          this.refreshSessions();
        } catch (err) {
          this.toast(err.message, true);
        }
      },
      async unfollowSession(sessionId) {
        try {
          await this.api('/unfollowSession', { sessionId });
          this.toast('Vous ne suivez plus cette session. Vous ne recevrez plus les notifications.');
          this.refreshSessions();
        } catch (err) {
          this.toast(err.message, true);
        }
      },
      async restoreAuth() {
        const payload = this.readAuthCookie();
        if (!payload) {
          this.showAuthModal();
          return;
        }
        try {
          const response = await this.api('/signin', payload);
          this.onAuthenticated(response.user);
        } catch (err) {
          document.cookie = 'badlyAuth=; Max-Age=0; path=/';
          this.showAuthModal();
        }
      },
      readAuthCookie() {
        const value = document.cookie.split('; ').find((part) => part.startsWith('badlyAuth='));
        if (!value) return null;
        const raw = decodeURIComponent(value.split('=')[1] || '');
        try {
          const parsed = JSON.parse(raw);
          if (parsed && parsed.name && parsed.passwordHash) {
            return parsed;
          }
        } catch (err) {
          return null;
        }
        return null;
      },
      async api(path, body, extra = {}) {
        const method = extra.method || (body ? 'POST' : 'GET');
        const headers = { ...(extra.headers || {}) };
        const options = { ...extra, method, headers };
        if (method !== 'GET') {
          headers['Content-Type'] = 'application/json';
          options.body = JSON.stringify(body ?? {});
        }

        let response;
        try {
          response = await fetch(path, options);
        } catch (err) {
          throw new Error('Connexion au serveur impossible');
        }

        let data;
        try {
          data = await response.json();
        } catch (err) {
          throw new Error('R√©ponse invalide');
        }

        if (!response.ok || !data || data.ok !== true) {
          throw new Error((data && data.error) || 'Erreur serveur');
        }

        if (data.user) {
          this.updateAuthCookie(data.user);
        }
        return data;
      },
      updateAuthCookie(user) {
        const value = encodeURIComponent(JSON.stringify({ name: user.name, passwordHash: user.passwordHash }));
        document.cookie = `badlyAuth=${value}; Max-Age=2592000; path=/`;
      },
      toast(message, isError = false) {
        const toast = document.createElement('div');
        toast.className = `toast${isError ? ' error' : ''}`;
        toast.textContent = message;
        this.$toastContainer.appendChild(toast);
        setTimeout(() => {
          toast.classList.add('fade-out');
          toast.addEventListener('transitionend', () => toast.remove(), { once: true });
          setTimeout(() => toast.remove(), 400);
        }, 3200);
      },
      checkInstallPrompt() {
        // V√©rifier si le cookie existe d√©j√†
        const hasSeenPrompt = this.getCookie('badlyInstallPromptSeen');
        if (hasSeenPrompt === 'true') {
          return;
        }

        // D√©tecter si l'utilisateur est sur mobile
        const userAgent = navigator.userAgent || navigator.vendor || window.opera;
        const isIOS = /iPad|iPhone|iPod/.test(userAgent) && !window.MSStream;
        const isAndroid = /android/i.test(userAgent);
        
        // V√©rifier si d√©j√† install√© (mode standalone)
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches 
          || window.navigator.standalone 
          || document.referrer.includes('android-app://');

        if (isStandalone) {
          // L'app est d√©j√† install√©e, pas besoin d'afficher le prompt
          this.setCookie('badlyInstallPromptSeen', 'true', 365);
          return;
        }

        if (isIOS) {
          this.showInstallPrompt('ios');
        } else if (isAndroid) {
          this.showInstallPrompt('android');
        }
        // Sinon, on n'affiche rien (desktop)
      },
      showInstallPrompt(platform) {
        const instructions = this.$installInstructions;
        
        if (platform === 'ios') {
          instructions.innerHTML = `
            <div class="install-step">
              <div class="install-step-number">1</div>
              <div class="install-step-text">
                Appuyez sur le bouton <strong>"Partager"</strong> <span class="install-icon">üì§</span> en bas de Safari
              </div>
            </div>
            <div class="install-step">
              <div class="install-step-number">2</div>
              <div class="install-step-text">
                Faites d√©filer et s√©lectionnez <strong>"Sur l'√©cran d'accueil"</strong> <span class="install-icon">‚ûï</span>
              </div>
            </div>
            <div class="install-step">
              <div class="install-step-number">3</div>
              <div class="install-step-text">
                Appuyez sur <strong>"Ajouter"</strong> pour confirmer
              </div>
            </div>
          `;
        } else if (platform === 'android') {
          instructions.innerHTML = `
            <div class="install-step">
              <div class="install-step-number">1</div>
              <div class="install-step-text">
                Appuyez sur le menu <span class="install-icon">‚ãÆ</span> en haut √† droite de Chrome
              </div>
            </div>
            <div class="install-step">
              <div class="install-step-number">2</div>
              <div class="install-step-text">
                S√©lectionnez <strong>"Ajouter √† l'√©cran d'accueil"</strong> ou <strong>"Installer l'application"</strong>
              </div>
            </div>
            <div class="install-step">
              <div class="install-step-number">3</div>
              <div class="install-step-text">
                Confirmez en appuyant sur <strong>"Ajouter"</strong>
              </div>
            </div>
          `;
        }

        this.$installPrompt.classList.remove('hidden');
        document.body.classList.add('modal-open');
      },
      dismissInstallPrompt(permanently = false) {
        this.$installPrompt.classList.add('hidden');
        document.body.classList.remove('modal-open');
        if (permanently) {
          // "J'ai compris !" : Enregistrer le cookie pour ne pas r√©afficher pendant 1 an
          this.setCookie('badlyInstallPromptSeen', 'true', 365);
        }
        // "Plus tard" : Pas de cookie, le popup r√©appara√Ætra √† la prochaine connexion
      },
      getCookie(name) {
        const value = document.cookie.split('; ').find((part) => part.startsWith(name + '='));
        if (!value) return null;
        return decodeURIComponent(value.split('=')[1] || '');
      },
      setCookie(name, value, days) {
        const maxAge = days * 24 * 60 * 60;
        document.cookie = `${name}=${encodeURIComponent(value)}; Max-Age=${maxAge}; path=/`;
      },
      async registerServiceWorker() {
        if (!('serviceWorker' in navigator)) {
          console.log('Service Workers non support√©s');
          return;
        }

        try {
          const registration = await navigator.serviceWorker.register('/service-worker.js');
          console.log('Service Worker enregistr√©:', registration);
          
          // Effacer le badge quand l'utilisateur ouvre l'app
          this.clearAppBadge();
        } catch (error) {
          console.error('Erreur lors de l\'enregistrement du Service Worker:', error);
        }
      },
      async clearAppBadge() {
        if ('clearAppBadge' in navigator) {
          try {
            await navigator.clearAppBadge();
          } catch (error) {
            console.log('Badge API non support√©');
          }
        }
      },
      async setupPushNotifications() {
        if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
          console.log('Les notifications push ne sont pas support√©es');
          return;
        }

        try {
          // R√©cup√©rer la cl√© publique VAPID
          const response = await this.api('/vapidPublicKey', null, { method: 'GET' });
          this.state.vapidPublicKey = response.publicKey;

          // V√©rifier si l'utilisateur a d√©j√† accord√© la permission
          const permission = await Notification.permission;
          
          if (permission === 'granted') {
            await this.subscribeToPush();
          } else if (permission === 'default') {
            // Demander la permission apr√®s un court d√©lai pour ne pas √™tre intrusif
            setTimeout(() => this.requestNotificationPermission(), 3000);
          }
        } catch (error) {
          console.error('Erreur lors de la configuration des notifications:', error);
        }
      },
      async requestNotificationPermission() {
        try {
          const permission = await Notification.requestPermission();
          
          if (permission === 'granted') {
            this.toast('Notifications activ√©es ! Vous serez notifi√© des nouvelles sessions.');
            await this.subscribeToPush();
          } else if (permission === 'denied') {
            console.log('Permission de notification refus√©e');
          }
        } catch (error) {
          console.error('Erreur lors de la demande de permission:', error);
        }
      },
      async subscribeToPush() {
        try {
          const registration = await navigator.serviceWorker.ready;
          
          // V√©rifier s'il existe d√©j√† un abonnement
          let subscription = await registration.pushManager.getSubscription();
          
          if (!subscription) {
            // Cr√©er un nouvel abonnement
            const urlBase64ToUint8Array = (base64String) => {
              const padding = '='.repeat((4 - base64String.length % 4) % 4);
              const base64 = (base64String + padding)
                .replace(/\-/g, '+')
                .replace(/_/g, '/');
              const rawData = window.atob(base64);
              const outputArray = new Uint8Array(rawData.length);
              for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
              }
              return outputArray;
            };

            subscription = await registration.pushManager.subscribe({
              userVisibleOnly: true,
              applicationServerKey: urlBase64ToUint8Array(this.state.vapidPublicKey)
            });
          }

          // Envoyer l'abonnement au serveur
          await this.api('/subscribePush', subscription.toJSON());
          this.state.pushSubscription = subscription;
          console.log('Abonn√© aux notifications push');
        } catch (error) {
          console.error('Erreur lors de l\'abonnement aux notifications:', error);
        }
      },
      async unsubscribeFromPush() {
        try {
          if (this.state.pushSubscription) {
            await this.state.pushSubscription.unsubscribe();
            await this.api('/unsubscribePush', { 
              endpoint: this.state.pushSubscription.endpoint 
            });
            this.state.pushSubscription = null;
            console.log('D√©sabonn√© des notifications push');
          }
        } catch (error) {
          console.error('Erreur lors du d√©sabonnement:', error);
        }
      }
    };

    document.addEventListener('DOMContentLoaded', () => {
      app.init();
      // Afficher "Badly-dev" dans le titre si l'URL contient "dev"
      if (window.location.href.includes('dev')) {
        document.title = 'Badly-dev';
      }
    });
  </script>
</body>
</html>
