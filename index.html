<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
  <title>Badly - Organise tes sessions de badminton entre amis √† Lyon</title>
  <meta name="description" content="Badly est l'application pour organiser et rejoindre des sessions de badminton entre amis √† Lyon. Trouve des partenaires, r√©serve des cr√©neaux et joue au bad facilement.">
  <meta name="keywords" content="badminton, bad, lyon, session, sport, amis, partenaires, r√©servation, club, match">
  <meta name="author" content="Badly">
  <meta name="robots" content="index, follow">
  <link rel="canonical" href="https://badly.ovh/">

  <meta name="theme-color" content="#202245">
  <link rel="icon" href="/favicon.png" type="image/png">
  <link rel="apple-touch-icon" href="/favicon.png">
  <link rel="manifest" href="/manifest.json">
  <link rel="stylesheet" href="/style.css">

  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "Badly",
    "description": "Application pour organiser et rejoindre des sessions de badminton entre amis √† Lyon",
    "url": "https://badly.ovh",
    "applicationCategory": "SportsApplication",
    "operatingSystem": "Web",
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "EUR"
    },
    "aggregateRating": {
      "@type": "AggregateRating",
      "ratingValue": "5",
      "ratingCount": "1"
    },
    "author": {
      "@type": "Organization",
      "name": "Badly"
    }
  }
  </script>
</head>
<body>
  <div id="app">
    <header class="app-header">
      <div class="brand">
        <img src="/favicon.png" alt="Badly" class="brand-icon">
        <span>Badly</span>
      </div>
      <div class="user-menu">
        <button id="user-button" class="user-button hidden">
          <span id="user-button-label"></span>
          <span class="indicator">‚ñº</span>
        </button>
        <div id="user-dropdown" class="user-dropdown hidden">
          <strong id="user-name"></strong>
          <button id="signout-button" type="button">Se d√©connecter</button>
          <div id="app-version" class="app-version hidden"></div>
        </div>
      </div>
    </header>
    <main>
      <div id="sessions-empty" class="empty-state hidden">
        Aucune session √† venir pour le moment. Cliquez sur + pour en cr√©er une.
      </div>
      <div id="sessions-list" class="sessions-list"></div>
    </main>
    <button id="create-session-button" class="fab hidden" title="Cr√©er une session">+</button>
  </div>

  <div id="backdrop" class="backdrop hidden"></div>

  <div id="auth-modal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="modal-card">
      <img src="/favicon.png" alt="Badly" class="auth-logo">
      <h1>Badly<br><small>Le badminton √† Lyon !</small></h1>
      <div class="auth-tabs">
        <button type="button" data-mode="signin" class="active">Connexion</button>
        <button type="button" data-mode="signup">Inscription</button>
      </div>
      <form id="signin-form">
        <label>
          Nom d'utilisateur
          <input name="name" type="text" autocomplete="username" required minlength="3" maxlength="20" pattern="[A-Za-z0-9_-]+">
        </label>
        <label>
          Mot de passe
          <input name="password" type="password" autocomplete="current-password" required minlength="6">
        </label>
        <div class="form-actions">
          <button type="submit" class="btn-primary">Connexion</button>
        </div>
      </form>
      <form id="signup-form" class="hidden">
        <label>
          Nom d'utilisateur
          <input name="name" type="text" autocomplete="off" required minlength="3" maxlength="20" pattern="[A-Za-z0-9_-]+">
        </label>
        <label>
          Mot de passe
          <input name="password" type="password" autocomplete="new-password" required minlength="6" maxlength="64">
        </label>
        <label>
          Confirmation
          <input name="confirm" type="password" autocomplete="new-password" required minlength="6" maxlength="64">
        </label>
        <div class="form-actions">
          <button type="submit" class="btn-primary">Inscription</button>
        </div>
      </form>
    </div>
  </div>

  <div id="session-modal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="modal-card">
      <h2 id="session-modal-title">Nouvelle session</h2>
      <form id="session-form">
        <input type="hidden" name="sessionId" value="">
        <label>
          Club
          <select name="club" required></select>
        </label>
        <label>
          Date et heure
          <input name="datetime" type="datetime-local" required>
        </label>
        <label>
          Niveau des joueurs
          <select name="level" required>
            <option value="d√©butant">D√©butant</option>
            <option value="d√©butant/moyen">D√©butant/Moyen</option>
            <option value="moyen" selected>Moyen</option>
            <option value="confirm√©">Confirm√©</option>
          </select>
        </label>
        <label>
          Dur√©e
          <select name="duration" required>
            <option value="45">45 minutes</option>
            <option value="60">1 heure</option>
            <option value="90" selected>1 heure 30</option>
            <option value="120">2 heures</option>
          </select>
        </label>
        <label>
          Nombre de participants
          <select name="capacity" required>
            <option value="4">4 joueurs</option>
            <option value="8" selected>8 joueurs</option>
          </select>
        </label>
        <label>
          Prix par participant (EUR)
          <input name="price" type="number" min="0" max="200" step="0.5" value="8" required>
        </label>
        <div class="form-actions">
          <button type="button" id="session-cancel" class="btn-secondary">Annuler</button>
          <button type="button" id="session-delete" class="btn-danger hidden">Supprimer</button>
          <button type="submit" id="session-submit" class="btn-primary">Cr√©er</button>
        </div>
      </form>
    </div>
  </div>

  <div id="participants-modal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="modal-card participants-modal-card">
      <div class="participants-modal-header">
        <h2>Participants</h2>
        <span id="participants-count" class="pill">0/0</span>
      </div>
      <div id="participants-list" class="participants-list"></div>
      <div class="add-participant-form">
        <input type="text" id="add-participant-input" placeholder="Nom du participant..." maxlength="20">
        <button type="button" id="add-participant-btn" class="btn-primary">Ajouter</button>
      </div>
      <div class="form-actions">
        <button type="button" id="participants-cancel" class="btn-secondary">Annuler</button>
        <button type="button" id="participants-save" class="btn-primary">Enregistrer</button>
      </div>
    </div>
  </div>

  <div id="toast-container" class="toast-container"></div>

  <div id="install-prompt" class="install-prompt hidden">
    <div class="install-prompt-card">
      <div class="install-prompt-header">
        <h2>üì± Installez Badly sur votre t√©l√©phone</h2>
        <p>Acc√©dez rapidement √† l'application directement depuis votre √©cran d'accueil !</p>
      </div>
      <div class="install-instructions" id="install-instructions">
        <!-- Les instructions seront ins√©r√©es ici selon le type d'appareil -->
      </div>
      <div class="install-prompt-actions">
        <button type="button" id="install-dismiss" class="btn-dismiss">Plus tard</button>
        <button type="button" id="install-understood" class="btn-understood">J'ai compris !</button>
      </div>
    </div>
  </div>

  <script>
    const app = {
      state: {
        user: null,
        version: null,
        sessions: [],
        clubs: [],
        pushSubscription: null,
        vapidPublicKey: null
      },
      init() {
        this.cacheElements();
        this.bindEvents();
        this.loadVersion();
        this.restoreAuth();
        this.startAutoRefresh();
        this.registerServiceWorker();
      },
      startAutoRefresh() {
        setInterval(() => {
          if (this.state.user && !this.hasChatDraft()) {
            this.refreshSessions();
          }
        }, 60000);
      },
      hasChatDraft() {
        return Array.from(document.querySelectorAll('.chat-form input'))
          .some((input) => input.value.length > 0);
      },
      cacheElements() {
        this.$authModal = document.getElementById('auth-modal');
        this.$sessionModal = document.getElementById('session-modal');
        this.$backdrop = document.getElementById('backdrop');
        this.$signinForm = document.getElementById('signin-form');
        this.$signupForm = document.getElementById('signup-form');
        this.$sessionForm = document.getElementById('session-form');
        this.$sessionCancel = document.getElementById('session-cancel');
        this.$sessionDelete = document.getElementById('session-delete');
        this.$sessionSubmit = document.getElementById('session-submit');
        this.$sessionModalTitle = document.getElementById('session-modal-title');
        this.$sessionsList = document.getElementById('sessions-list');
        this.$sessionsEmpty = document.getElementById('sessions-empty');
        this.$toastContainer = document.getElementById('toast-container');
        this.$createButton = document.getElementById('create-session-button');
        this.$userButton = document.getElementById('user-button');
        this.$userButtonLabel = document.getElementById('user-button-label');
        this.$userDropdown = document.getElementById('user-dropdown');
        this.$userName = document.getElementById('user-name');
        this.$signoutButton = document.getElementById('signout-button');
        this.$appVersion = document.getElementById('app-version');
        this.$authTabs = this.$authModal.querySelectorAll('.auth-tabs button');
        this.$installPrompt = document.getElementById('install-prompt');
        this.$installInstructions = document.getElementById('install-instructions');
        this.$installDismiss = document.getElementById('install-dismiss');
        this.$installUnderstood = document.getElementById('install-understood');
        this.$main = document.querySelector('main');
        this.$header = document.querySelector('.app-header');
        this.$participantsModal = document.getElementById('participants-modal');
        this.$participantsList = document.getElementById('participants-list');
        this.$participantsCount = document.getElementById('participants-count');
        this.$addParticipantInput = document.getElementById('add-participant-input');
        this.$addParticipantBtn = document.getElementById('add-participant-btn');
        this.$participantsCancel = document.getElementById('participants-cancel');
        this.$participantsSave = document.getElementById('participants-save');
      },
      disablePinchZoom() {
        document.addEventListener('gesturestart', (event) => event.preventDefault());
        document.addEventListener('gesturechange', (event) => event.preventDefault());
        document.addEventListener('gestureend', (event) => event.preventDefault());
        document.addEventListener('touchmove', (event) => {
          if (event.touches.length > 1) {
            event.preventDefault();
          }
        }, { passive: false });
      },
      bindEvents() {
        this.disablePinchZoom();
        document.addEventListener('click', (event) => {
          if (!this.$userDropdown) return;
          const isButton = event.target.closest('#user-button');
          const isDropdown = event.target.closest('#user-dropdown');
          if (isButton) {
            this.toggleDropdown();
          } else if (!isDropdown) {
            this.closeDropdown();
          }
        });

        this.$signoutButton.addEventListener('click', () => this.signout());
        this.$createButton.addEventListener('click', () => this.openSessionModal());
        this.$sessionCancel.addEventListener('click', () => this.closeSessionModal());
        this.$sessionDelete.addEventListener('click', () => this.deleteSessionFromModal());
        this.$backdrop.addEventListener('click', () => {
          if (!this.$sessionModal.classList.contains('hidden')) {
            this.closeSessionModal();
          }
          if (!this.$participantsModal.classList.contains('hidden')) {
            this.closeParticipantsModal();
          }
        });
        this.$participantsCancel.addEventListener('click', () => this.closeParticipantsModal());
        this.$participantsSave.addEventListener('click', () => this.saveParticipants());
        this.$addParticipantBtn.addEventListener('click', () => this.addParticipantFromInput());
        this.$addParticipantInput.addEventListener('keypress', (event) => {
          if (event.key === 'Enter') {
            event.preventDefault();
            this.addParticipantFromInput();
          }
        });

        this.$signinForm.addEventListener('submit', (event) => {
          event.preventDefault();
          const formData = new FormData(this.$signinForm);
          const name = formData.get('name').trim();
          const password = formData.get('password');
          if (!name || !password) {
            this.toast('Champs manquants', true);
            return;
          }
          this.signin({ name, password });
        });

        this.$signupForm.addEventListener('submit', (event) => {
          event.preventDefault();
          const formData = new FormData(this.$signupForm);
          const name = formData.get('name').trim();
          const password = formData.get('password');
          const confirm = formData.get('confirm');
          if (password !== confirm) {
            this.toast('Les mots de passe ne correspondent pas', true);
            return;
          }
          if (password.length < 6) {
            this.toast('Mot de passe trop court', true);
            return;
          }
          this.signup({ name, password });
        });

        this.$sessionForm.addEventListener('submit', (event) => {
          event.preventDefault();
          const formData = new FormData(this.$sessionForm);
          const sessionId = formData.get('sessionId');
          const club = formData.get('club');
          const datetimeValue = formData.get('datetime');
          const level = formData.get('level');
          const duration = Number(formData.get('duration'));
          const capacity = Number(formData.get('capacity'));
          const price = Number(formData.get('price'));

          if (!club || !datetimeValue) {
            this.toast('Merci de renseigner tous les champs', true);
            return;
          }

          const datetime = new Date(datetimeValue);
          if (Number.isNaN(datetime.getTime())) {
            this.toast('Date invalide', true);
            return;
          }

          // V√©rifier que l'heure est un multiple de 15 minutes
          const minutes = datetime.getMinutes();
          if (minutes % 15 !== 0) {
            this.toast('L\'heure doit √™tre un multiple de 15 minutes (ex: 9h00, 9h15, 9h30, 9h45)', true);
            return;
          }

          const payload = {
            club,
            datetime: datetime.toISOString(),
            level,
            durationMinutes: duration,
            capacity,
            pricePerParticipant: price
          };

          if (sessionId) {
            // Mode √©dition
            payload.sessionId = sessionId;
            this.editSession(payload);
          } else {
            // Mode cr√©ation
            this.createSession(payload);
          }
        });

        this.$authTabs.forEach((button) => {
          button.addEventListener('click', () => {
            this.$authTabs.forEach((tab) => tab.classList.toggle('active', tab === button));
            if (button.dataset.mode === 'signin') {
              this.$signinForm.classList.remove('hidden');
              this.$signupForm.classList.add('hidden');
            } else {
              this.$signinForm.classList.add('hidden');
              this.$signupForm.classList.remove('hidden');
            }
          });
        });

        this.$installDismiss.addEventListener('click', () => this.dismissInstallPrompt());
        this.$installUnderstood.addEventListener('click', () => this.dismissInstallPrompt(true));
      },
      async signup(credentials) {
        if (this._signingUp) return;
        this._signingUp = true;
        try {
          const response = await this.api('/signup', credentials);
          this.toast('Inscription r√©ussie');
          this.onAuthenticated(response.user);
        } catch (err) {
          this.toast(err.message, true);
        } finally {
          this._signingUp = false;
        }
      },
      async signin(credentials, silent = false) {
        if (this._signingIn) return;
        this._signingIn = true;
        try {
          const response = await this.api('/signin', credentials);
          if (!silent) {
            this.toast('Connexion r√©ussie');
          }
          this.onAuthenticated(response.user);
        } catch (err) {
          this.toast(err.message, true);
        } finally {
          this._signingIn = false;
        }
      },
      async signout() {
        try {
          await this.api('/signout', {});
        } catch (err) {
          // signout should not block even if request fails
        }
        document.cookie = 'badlyAuth=; Max-Age=0; path=/';
        document.cookie = 'badlyInstallPromptSeen=; Max-Age=0; path=/';
        this.state.user = null;
        this.state.sessions = [];
        this.renderSessions();
        this.updateUserMenu();
        this.showAuthModal();
        this.toggleFab();
        this.closeDropdown();
      },
      onAuthenticated(user) {
        this.state.user = {
          ...user,
          normalized: user.name.toLowerCase()
        };
        this.hideAuthModal();
        this.toggleFab();
        this.updateUserMenu();
        this.refreshSessions();
        this.checkInstallPrompt();
        this.setupPushNotifications();
      },
      toggleFab() {
        if (this.state.user) {
          this.$createButton.classList.remove('hidden');
        } else {
          this.$createButton.classList.add('hidden');
        }
      },
      updateUserMenu() {
        if (!this.state.user) {
          this.$userButton.classList.add('hidden');
          return;
        }
        this.$userButton.classList.remove('hidden');
        this.$userName.textContent = this.state.user.name;
        this.$userButtonLabel.textContent = this.state.user.name;
        this.updateVersionLabel();
      },
      async loadVersion() {
        try {
          const response = await this.api('/version', null, { method: 'GET' });
          this.state.version = typeof response.version === 'string' ? response.version : null;
        } catch (err) {
          this.state.version = null;
        }
        this.updateVersionLabel();
      },
      updateVersionLabel() {
        if (!this.$appVersion) return;
        if (this.state.version) {
          this.$appVersion.textContent = `Version ${this.state.version}`;
          this.$appVersion.classList.remove('hidden');
        } else {
          this.$appVersion.textContent = '';
          this.$appVersion.classList.add('hidden');
        }
      },
      toggleDropdown() {
        this.$userDropdown.classList.toggle('hidden');
      },
      closeDropdown() {
        this.$userDropdown.classList.add('hidden');
      },
      openSessionModal(session = null) {
        if (!this.state.clubs.length) {
          this.toast('Aucun club r√©f√©renc√©. Ajoutez-en dans data.json.', true);
          return;
        }
        
        this.$sessionForm.reset();
        const select = this.$sessionForm.elements.namedItem('club');
        select.innerHTML = '';
        this.state.clubs.forEach((club) => {
          const option = document.createElement('option');
          option.value = club;
          option.textContent = club;
          select.appendChild(option);
        });

        if (session) {
          // Mode √©dition
          this.$sessionModalTitle.textContent = 'Modifier la session';
          this.$sessionSubmit.textContent = 'Enregistrer';
          this.$sessionDelete.classList.remove('hidden');
          
          // Remplir le formulaire avec les donn√©es de la session
          this.$sessionForm.elements.namedItem('sessionId').value = session.id;
          this.$sessionForm.elements.namedItem('club').value = session.club;
          this.$sessionForm.elements.namedItem('level').value = session.level;
          this.$sessionForm.elements.namedItem('duration').value = session.durationMinutes;
          this.$sessionForm.elements.namedItem('capacity').value = session.capacity;
          this.$sessionForm.elements.namedItem('price').value = session.pricePerParticipant;
          
          const sessionDate = new Date(session.datetime);
          const local = new Date(sessionDate.getTime() - sessionDate.getTimezoneOffset() * 60000);
          this.$sessionForm.elements.namedItem('datetime').value = local.toISOString().slice(0, 16);
        } else {
          // Mode cr√©ation
          this.$sessionModalTitle.textContent = 'Nouvelle session';
          this.$sessionSubmit.textContent = 'Cr√©er';
          this.$sessionDelete.classList.add('hidden');
          this.$sessionForm.elements.namedItem('sessionId').value = '';
          
          const datetimeInput = this.$sessionForm.elements.namedItem('datetime');
          const now = new Date();
          // Arrondir au prochain quart d'heure
          const minutes = now.getMinutes();
          const roundedMinutes = Math.ceil(minutes / 15) * 15;
          now.setMinutes(roundedMinutes);
          now.setSeconds(0);
          now.setMilliseconds(0);
          const local = new Date(now.getTime() - now.getTimezoneOffset() * 60000);
          datetimeInput.value = local.toISOString().slice(0, 16);
        }
        
        this.$sessionModal.classList.remove('hidden');
        this.$backdrop.classList.remove('hidden');
        document.body.classList.add('modal-open');
      },
      closeSessionModal() {
        this.$sessionModal.classList.add('hidden');
        this.$backdrop.classList.add('hidden');
        this.$sessionForm.reset();
        document.body.classList.remove('modal-open');
      },
      showAuthModal() {
        this.$authModal.classList.remove('hidden');
        this.$backdrop.classList.remove('hidden');
        this.$main.classList.add('hidden');
        this.$header.classList.add('hidden');
        document.body.classList.add('modal-open');
      },
      hideAuthModal() {
        this.$authModal.classList.add('hidden');
        this.$backdrop.classList.add('hidden');
        this.$main.classList.remove('hidden');
        this.$header.classList.remove('hidden');
        this.$signinForm.reset();
        this.$signupForm.reset();
        document.body.classList.remove('modal-open');
      },
      async refreshSessions() {
        try {
          const response = await this.api('/listSessions', null, { method: 'GET' });
          this.state.sessions = response.sessions || [];
          this.state.clubs = response.clubs || [];
          this.state.validUsernames = response.validUsernames || [];
          this.renderSessions();
        } catch (err) {
          this.toast(err.message, true);
        }
      },
      renderSessions() {
        const list = this.$sessionsList;
        list.innerHTML = '';
        if (!this.state.sessions.length) {
          this.$sessionsEmpty.classList.remove('hidden');
          return;
        }
        this.$sessionsEmpty.classList.add('hidden');
        const now = Date.now();
        const dateFormatter = new Intl.DateTimeFormat('fr-FR', { weekday: 'short', day: '2-digit', month: 'short' });
        const timeFormatter = new Intl.DateTimeFormat('fr-FR', { hour: '2-digit', minute: '2-digit' });
        this.state.sessions.forEach((session) => {
          const card = document.createElement('article');
          card.className = 'session-card';

          const sessionDate = new Date(session.datetime);
          const durationLabel = this.formatDuration(session.durationMinutes);
          const priceLabel = Number(session.pricePerParticipant) === 0 ? 'Gratuit' : new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(session.pricePerParticipant);
          const participants = Array.isArray(session.participants) ? session.participants : [];
          const followers = Array.isArray(session.followers) ? session.followers : [];
          const participantCount = session.participantCount ?? (participants.length + 1);

          const header = document.createElement('header');
          header.innerHTML = `
            <div class="session-title">${session.club} <span>${dateFormatter.format(sessionDate)} ${timeFormatter.format(sessionDate)}</span></div>
            <span class="pill">${participantCount}/${session.capacity}</span>
          `;

          const meta = document.createElement('div');
          meta.className = 'session-meta';
          meta.innerHTML = `
            <span><strong>Organisateur :</strong> ${session.organizer}</span>
            ${session.level ? `<span><strong>Niveau :</strong> ${session.level}</span>` : ''}
            <span><strong>Dur√©e :</strong> ${durationLabel}</span>
            <span><strong>Tarif :</strong> ${priceLabel}</span>
          `;

          const participantsLine = document.createElement('div');
          participantsLine.className = 'participants-line';
          const others = participants.filter((name) => name !== session.organizer);
          const participantsText = others.length ? others.join(', ') : 'Aucun pour le moment';
          participantsLine.innerHTML = `<strong>Participants :</strong> ${participantsText}`;

          // Ligne des int√©ress√©s (followers)
          const followersLine = document.createElement('div');
          followersLine.className = 'participants-line';
          const followersText = followers.length ? followers.join(', ') : 'Aucun pour le moment';
          followersLine.innerHTML = `<strong>Int√©ress√©s :</strong> ${followersText}`;

          const actions = document.createElement('div');
          actions.className = 'session-actions';
          const isOrganizer = this.state.user && session.organizer === this.state.user.name;
          const isParticipant = this.state.user && participants.includes(this.state.user.name);
          const hasStarted = sessionDate.getTime() <= now;
          const isFull = participantCount >= session.capacity;

          if (this.state.user && !isOrganizer && !hasStarted) {
            if (isParticipant) {
              const leaveBtn = document.createElement('button');
              leaveBtn.className = 'btn-secondary';
              leaveBtn.textContent = 'Quitter';
              leaveBtn.addEventListener('click', () => this.leaveSession(session.id));
              actions.appendChild(leaveBtn);
            } else {
              const joinBtn = document.createElement('button');
              joinBtn.className = 'btn-primary';
              joinBtn.textContent = isFull ? 'Session pleine' : 'Rejoindre';
              if (isFull) {
                joinBtn.disabled = true;
                joinBtn.classList.add('btn-disabled');
              } else {
                joinBtn.addEventListener('click', () => this.joinSession(session.id));
              }
              actions.appendChild(joinBtn);
            }

            // Bouton Suivre / Ne plus suivre
            const isFollowing = followers.includes(this.state.user.name);
            const followBtn = document.createElement('button');
            followBtn.className = isFollowing ? 'btn-secondary' : 'btn-primary';
            followBtn.textContent = isFollowing ? 'Ne plus suivre' : 'Suivre';
            followBtn.addEventListener('click', () => {
              if (isFollowing) {
                this.unfollowSession(session.id);
              } else {
                this.followSession(session.id);
              }
            });
            actions.appendChild(followBtn);
          }

          if (this.state.user && isOrganizer && !hasStarted) {
            const editBtn = document.createElement('button');
            editBtn.className = 'btn-primary';
            editBtn.textContent = 'Modifier';
            editBtn.addEventListener('click', () => this.openSessionModal(session));
            actions.appendChild(editBtn);

            const participantsBtn = document.createElement('button');
            participantsBtn.className = 'btn-primary';
            participantsBtn.textContent = 'Participants';
            participantsBtn.addEventListener('click', () => this.openParticipantsModal(session));
            actions.appendChild(participantsBtn);
          }

          if (hasStarted && !actions.children.length) {
            const info = document.createElement('span');
            info.className = 'badge';
            info.textContent = 'Session d√©marr√©e';
            actions.appendChild(info);
          }

          card.appendChild(header);
          card.appendChild(meta);
          card.appendChild(followersLine);
          card.appendChild(participantsLine);

          // Section Chat (visible pour organisateur, participants et followers)
          const isFollower = this.state.user && followers.includes(this.state.user.name);
          const canAccessChat = this.state.user && (isOrganizer || isParticipant || isFollower);
          if (canAccessChat && !hasStarted) {
            const chatSection = document.createElement('details');
            chatSection.className = 'chat-section';

            const messages = Array.isArray(session.messages) ? session.messages : [];
            const chatToggle = document.createElement('summary');
            chatToggle.className = 'chat-toggle';
            chatToggle.textContent = `Chat (${messages.length})`;

            const chatMessages = document.createElement('div');
            chatMessages.className = 'chat-messages';
            chatMessages.innerHTML = this.renderChatMessages(messages);

            const chatForm = document.createElement('form');
            chatForm.className = 'chat-form';
            chatForm.innerHTML = `
              <input type="text" placeholder="Votre message..." maxlength="500" required>
              <button type="submit">Envoyer</button>
            `;
            chatForm.addEventListener('submit', (e) => {
              e.preventDefault();
              const input = chatForm.querySelector('input');
              const text = input.value.trim();
              if (text) {
                this.sendChatMessage(session.id, text);
                input.value = '';
              }
            });

            chatSection.appendChild(chatToggle);
            chatSection.appendChild(chatMessages);
            chatSection.appendChild(chatForm);
            card.appendChild(chatSection);
          }

          card.appendChild(actions);
          list.appendChild(card);
        });
      },
      renderChatMessages(messages) {
        if (!messages || messages.length === 0) {
          return '';
        }
        return messages.map(msg => `
          <div class="chat-message">
            <div class="chat-message-header">
              <span class="chat-message-sender">${this.escapeHtml(msg.sender)}</span>
              <span class="chat-message-time">${this.formatChatTime(msg.timestamp)}</span>
            </div>
            <div class="chat-message-text">${this.escapeHtml(msg.text)}</div>
          </div>
        `).join('');
      },
      formatChatTime(timestamp) {
        const date = new Date(timestamp);
        const now = new Date();
        const timeStr = date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });

        // M√™me jour
        if (date.toDateString() === now.toDateString()) {
          return timeStr;
        }

        // Hier
        const yesterday = new Date(now);
        yesterday.setDate(yesterday.getDate() - 1);
        if (date.toDateString() === yesterday.toDateString()) {
          return `Hier ${timeStr}`;
        }

        // Autre jour
        const dateStr = date.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' });
        return `${dateStr} ${timeStr}`;
      },
      escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      },
      async sendChatMessage(sessionId, text) {
        try {
          await this.api('/sendMessage', { sessionId, text });
          this.refreshSessions();
        } catch (err) {
          this.toast(err.message, true);
        }
      },
      formatDuration(minutes) {
        const total = Number(minutes) || 0;
        const hours = Math.floor(total / 60);
        const mins = total % 60;
        if (hours && mins) return `${hours} h ${mins} min`;
        if (hours) return `${hours} h`;
        return `${mins} min`;
      },
      async createSession(payload) {
        try {
          const response = await this.api('/createSession', payload);
          this.toast('Session cr√©√©e');
          this.closeSessionModal();
          this.refreshSessions();
          if (response.session) {
            this.addToCalendarAutomatically(response.session);
          }
        } catch (err) {
          this.toast(err.message, true);
        }
      },
      async editSession(payload) {
        try {
          await this.api('/editSession', payload);
          this.toast('Session modifi√©e');
          this.closeSessionModal();
          this.refreshSessions();
        } catch (err) {
          this.toast(err.message, true);
        }
      },
      async deleteSessionFromModal() {
        const sessionId = this.$sessionForm.elements.namedItem('sessionId').value;
        if (!sessionId) return;
        
        if (!confirm('Supprimer cette session ?')) return;
        
        try {
          await this.api('/deleteSession', { sessionId });
          this.toast('Session supprim√©e');
          this.closeSessionModal();
          this.refreshSessions();
        } catch (err) {
          this.toast(err.message, true);
        }
      },
      async deleteSession(sessionId) {
        if (!confirm('Supprimer cette session ?')) return;
        try {
          await this.api('/deleteSession', { sessionId });
          this.toast('Session supprim√©e');
          this.refreshSessions();
        } catch (err) {
          this.toast(err.message, true);
        }
      },
      async joinSession(sessionId) {
        try {
          const response = await this.api('/joinSession', { sessionId });
          this.toast('Inscription enregistr√©e');
          this.refreshSessions();
          if (response.session) {
            setTimeout(() => this.addToCalendarAutomatically(response.session), 500);
          }
        } catch (err) {
          this.toast(err.message, true);
        }
      },
      async leaveSession(sessionId) {
        try {
          await this.api('/leaveSession', { sessionId });
          this.toast('D√©sinscription enregistr√©e');
          this.refreshSessions();
        } catch (err) {
          this.toast(err.message, true);
        }
      },
      openParticipantsModal(session) {
        this.state.editingSession = session;
        this.state.editingParticipants = [...session.participants];
        this.renderParticipantsModal();
        this.$participantsModal.classList.remove('hidden');
        document.body.classList.add('modal-open');
      },
      closeParticipantsModal() {
        this.$participantsModal.classList.add('hidden');
        document.body.classList.remove('modal-open');
        this.state.editingSession = null;
        this.state.editingParticipants = [];
      },
      renderParticipantsModal() {
        const session = this.state.editingSession;
        const participants = this.state.editingParticipants;
        const validUsernames = this.state.validUsernames || [];
        const capacity = session.capacity;
        const spotsLeft = capacity - participants.length - 1; // -1 pour l'organisateur

        // Liste des participants
        const list = this.$participantsList;
        list.innerHTML = '';

        if (participants.length === 0) {
          const empty = document.createElement('div');
          empty.className = 'participants-empty';
          empty.textContent = 'Aucun participant';
          list.appendChild(empty);
        } else {
          participants.forEach((name, index) => {
            const item = document.createElement('div');
            item.className = 'participant-item';

            const isValidUser = validUsernames.some(u => u.toLowerCase() === name.toLowerCase());
            const icon = document.createElement('span');
            icon.className = 'participant-icon';
            icon.textContent = isValidUser ? '\u2713' : '\u{1F464}';
            icon.title = isValidUser ? 'Utilisateur inscrit' : 'Participant externe';

            const nameSpan = document.createElement('span');
            nameSpan.className = 'participant-name';
            nameSpan.textContent = name;

            const removeBtn = document.createElement('button');
            removeBtn.className = 'participant-remove';
            removeBtn.textContent = '\u00D7';
            removeBtn.title = 'Retirer';
            removeBtn.addEventListener('click', () => {
              this.state.editingParticipants.splice(index, 1);
              this.renderParticipantsModal();
            });

            item.appendChild(icon);
            item.appendChild(nameSpan);
            item.appendChild(removeBtn);
            list.appendChild(item);
          });
        }

        // Mise √† jour du compteur
        this.$participantsCount.textContent = `${participants.length + 1}/${capacity}`;

        // Activer/d√©sactiver le bouton d'ajout
        const addBtn = this.$addParticipantBtn;
        const input = this.$addParticipantInput;
        if (spotsLeft <= 0) {
          addBtn.disabled = true;
          input.disabled = true;
          input.placeholder = 'Session complete';
        } else {
          addBtn.disabled = false;
          input.disabled = false;
          input.placeholder = 'Nom du participant...';
        }
      },
      addParticipantFromInput() {
        const input = this.$addParticipantInput;
        const name = input.value.trim();
        if (!name) return;

        const session = this.state.editingSession;
        const participants = this.state.editingParticipants;
        const spotsLeft = session.capacity - participants.length - 1;

        if (spotsLeft <= 0) {
          this.toast('Session complete', true);
          return;
        }

        // V√©rifier si le nom est d√©j√† dans la liste
        if (participants.some(p => p.toLowerCase() === name.toLowerCase())) {
          this.toast('Ce participant est deja inscrit', true);
          return;
        }

        // V√©rifier si c'est l'organisateur
        if (name.toLowerCase() === session.organizer.toLowerCase()) {
          this.toast('L\'organisateur ne peut pas etre ajoute comme participant', true);
          return;
        }

        participants.push(name);
        input.value = '';
        this.renderParticipantsModal();
      },
      async saveParticipants() {
        const session = this.state.editingSession;
        const participants = this.state.editingParticipants;

        try {
          await this.api('/updateParticipants', {
            sessionId: session.id,
            participants: participants
          });
          this.toast('Participants mis a jour');
          this.closeParticipantsModal();
          this.refreshSessions();
        } catch (err) {
          this.toast(err.message, true);
        }
      },
      async followSession(sessionId) {
        try {
          await this.api('/followSession', { sessionId });
          this.toast('Vous suivez maintenant cette session. Vous recevrez toutes les notifications.');
          this.refreshSessions();
        } catch (err) {
          this.toast(err.message, true);
        }
      },
      async unfollowSession(sessionId) {
        try {
          await this.api('/unfollowSession', { sessionId });
          this.toast('Vous ne suivez plus cette session. Vous ne recevrez plus les notifications.');
          this.refreshSessions();
        } catch (err) {
          this.toast(err.message, true);
        }
      },
      async restoreAuth() {
        const payload = this.readAuthCookie();
        if (!payload) {
          this.showAuthModal();
          return;
        }
        try {
          const response = await this.api('/signin', payload);
          this.onAuthenticated(response.user);
        } catch (err) {
          document.cookie = 'badlyAuth=; Max-Age=0; path=/';
          this.showAuthModal();
        }
      },
      readAuthCookie() {
        const value = document.cookie.split('; ').find((part) => part.startsWith('badlyAuth='));
        if (!value) return null;
        const raw = decodeURIComponent(value.split('=')[1] || '');
        try {
          const parsed = JSON.parse(raw);
          if (parsed && parsed.name && parsed.passwordHash) {
            return parsed;
          }
        } catch (err) {
          return null;
        }
        return null;
      },
      async api(path, body, extra = {}) {
        const method = extra.method || (body ? 'POST' : 'GET');
        const headers = { ...(extra.headers || {}) };
        const options = { ...extra, method, headers };
        if (method !== 'GET') {
          headers['Content-Type'] = 'application/json';
          options.body = JSON.stringify(body ?? {});
        }

        let response;
        try {
          response = await fetch(path, options);
        } catch (err) {
          throw new Error('Connexion au serveur impossible');
        }

        const rawText = await response.text();
        let data = null;
        if (rawText) {
          try {
            data = JSON.parse(rawText);
          } catch (err) {
            data = null;
          }
        }

        const fallbackMessage = rawText && !rawText.trim().startsWith('<') ? rawText.trim() : '';
        if (!data) {
          if (response.ok) {
            throw new Error('R√©ponse invalide');
          }
          throw new Error(fallbackMessage || 'Erreur serveur');
        }

        if (!response.ok || data.ok !== true) {
          throw new Error(data.error || fallbackMessage || 'Erreur serveur');
        }

        if (data.user) {
          this.updateAuthCookie(data.user);
        }
        return data;
      },
      updateAuthCookie(user) {
        const value = encodeURIComponent(JSON.stringify({ name: user.name, passwordHash: user.passwordHash }));
        document.cookie = `badlyAuth=${value}; Max-Age=2592000; path=/`;
      },
      toast(message, isError = false) {
        const toast = document.createElement('div');
        toast.className = `toast${isError ? ' error' : ''}`;
        toast.textContent = message;
        this.$toastContainer.appendChild(toast);
        setTimeout(() => {
          toast.classList.add('fade-out');
          toast.addEventListener('transitionend', () => toast.remove(), { once: true });
          setTimeout(() => toast.remove(), 400);
        }, 3200);
      },
      checkInstallPrompt() {
        // V√©rifier si le cookie existe d√©j√†
        const hasSeenPrompt = this.getCookie('badlyInstallPromptSeen');
        if (hasSeenPrompt === 'true') {
          return;
        }

        // D√©tecter si l'utilisateur est sur mobile
        const userAgent = navigator.userAgent || navigator.vendor || window.opera;
        const isIOS = /iPad|iPhone|iPod/.test(userAgent) && !window.MSStream;
        const isAndroid = /android/i.test(userAgent);
        
        // V√©rifier si d√©j√† install√© (mode standalone)
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches 
          || window.navigator.standalone 
          || document.referrer.includes('android-app://');

        if (isStandalone) {
          // L'app est d√©j√† install√©e, pas besoin d'afficher le prompt
          this.setCookie('badlyInstallPromptSeen', 'true', 365);
          return;
        }

        if (isIOS) {
          this.showInstallPrompt('ios');
        } else if (isAndroid) {
          this.showInstallPrompt('android');
        }
        // Sinon, on n'affiche rien (desktop)
      },
      showInstallPrompt(platform) {
        const instructions = this.$installInstructions;
        
        if (platform === 'ios') {
          instructions.innerHTML = `
            <div class="install-step">
              <div class="install-step-number">1</div>
              <div class="install-step-text">
                Appuyez sur le bouton <strong>"Partager"</strong> en bas de Safari
              </div>
            </div>
            <div class="install-step">
              <div class="install-step-number">2</div>
              <div class="install-step-text">
                Faites d√©filer et s√©lectionnez <strong>"Sur l'√©cran d'accueil"</strong>
              </div>
            </div>
            <div class="install-step">
              <div class="install-step-number">3</div>
              <div class="install-step-text">
                Appuyez sur <strong>"Ajouter"</strong> pour confirmer
              </div>
            </div>
          `;
        } else if (platform === 'android') {
          instructions.innerHTML = `
            <div class="install-step">
              <div class="install-step-number">1</div>
              <div class="install-step-text">
                Appuyez sur le menu en haut √† droite de Chrome
              </div>
            </div>
            <div class="install-step">
              <div class="install-step-number">2</div>
              <div class="install-step-text">
                S√©lectionnez <strong>"Ajouter √† l'√©cran d'accueil"</strong> ou <strong>"Installer l'application"</strong>
              </div>
            </div>
            <div class="install-step">
              <div class="install-step-number">3</div>
              <div class="install-step-text">
                Confirmez en appuyant sur <strong>"Ajouter"</strong>
              </div>
            </div>
          `;
        }

        this.$installPrompt.classList.remove('hidden');
        document.body.classList.add('modal-open');
      },
      dismissInstallPrompt(permanently = false) {
        this.$installPrompt.classList.add('hidden');
        document.body.classList.remove('modal-open');
        if (permanently) {
          // "J'ai compris !" : Enregistrer le cookie pour ne pas r√©afficher pendant 1 an
          this.setCookie('badlyInstallPromptSeen', 'true', 365);
        }
        // "Plus tard" : Pas de cookie, le popup r√©appara√Ætra √† la prochaine connexion
      },
      getCookie(name) {
        const value = document.cookie.split('; ').find((part) => part.startsWith(name + '='));
        if (!value) return null;
        return decodeURIComponent(value.split('=')[1] || '');
      },
      setCookie(name, value, days) {
        const maxAge = days * 24 * 60 * 60;
        document.cookie = `${name}=${encodeURIComponent(value)}; Max-Age=${maxAge}; path=/`;
      },
      async registerServiceWorker() {
        if (!('serviceWorker' in navigator)) {
          console.log('Service Workers non support√©s');
          return;
        }

        try {
          const registration = await navigator.serviceWorker.register('/service-worker.js');
          console.log('Service Worker enregistr√©:', registration);
          
          // Effacer le badge quand l'utilisateur ouvre l'app
          this.clearAppBadge();
        } catch (error) {
          console.error('Erreur lors de l\'enregistrement du Service Worker:', error);
        }
      },
      async clearAppBadge() {
        if ('clearAppBadge' in navigator) {
          try {
            await navigator.clearAppBadge();
          } catch (error) {
            console.log('Badge API non support√©');
          }
        }
      },
      async setupPushNotifications() {
        if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
          console.log('Les notifications push ne sont pas support√©es');
          return;
        }

        try {
          // R√©cup√©rer la cl√© publique VAPID
          const response = await this.api('/vapidPublicKey', null, { method: 'GET' });
          this.state.vapidPublicKey = response.publicKey;

          // V√©rifier si l'utilisateur a d√©j√† accord√© la permission
          const permission = await Notification.permission;
          
          if (permission === 'granted') {
            await this.subscribeToPush();
          } else if (permission === 'default') {
            // Demander la permission apr√®s un court d√©lai pour ne pas √™tre intrusif
            setTimeout(() => this.requestNotificationPermission(), 3000);
          }
        } catch (error) {
          console.error('Erreur lors de la configuration des notifications:', error);
        }
      },
      async requestNotificationPermission() {
        try {
          const permission = await Notification.requestPermission();
          
          if (permission === 'granted') {
            this.toast('Notifications activ√©es ! Vous serez notifi√© des nouvelles sessions.');
            await this.subscribeToPush();
          } else if (permission === 'denied') {
            console.log('Permission de notification refus√©e');
          }
        } catch (error) {
          console.error('Erreur lors de la demande de permission:', error);
        }
      },
      async subscribeToPush() {
        try {
          const registration = await navigator.serviceWorker.ready;
          
          // V√©rifier s'il existe d√©j√† un abonnement
          let subscription = await registration.pushManager.getSubscription();
          
          if (!subscription) {
            // Cr√©er un nouvel abonnement
            const urlBase64ToUint8Array = (base64String) => {
              const padding = '='.repeat((4 - base64String.length % 4) % 4);
              const base64 = (base64String + padding)
                .replace(/\-/g, '+')
                .replace(/_/g, '/');
              const rawData = window.atob(base64);
              const outputArray = new Uint8Array(rawData.length);
              for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
              }
              return outputArray;
            };

            subscription = await registration.pushManager.subscribe({
              userVisibleOnly: true,
              applicationServerKey: urlBase64ToUint8Array(this.state.vapidPublicKey)
            });
          }

          // Envoyer l'abonnement au serveur
          await this.api('/subscribePush', subscription.toJSON());
          this.state.pushSubscription = subscription;
          console.log('Abonn√© aux notifications push');
        } catch (error) {
          console.error('Erreur lors de l\'abonnement aux notifications:', error);
        }
      },
      isIOSDevice() {
        const userAgent = navigator.userAgent || navigator.vendor || window.opera;
        return /iPad|iPhone|iPod/.test(userAgent) && !window.MSStream;
      },
      addToCalendarAutomatically(session) {
        if (!confirm('Ajouter au calendrier ?')) {
          return;
        }
        
        const details = this.buildCalendarEventDetails(session);
        
        if (this.isIOSDevice()) {
          // iOS: t√©l√©charger un fichier .ics pour Apple Calendar
          this.downloadIcsFile(details);
        } else {
          // Autres appareils: ouvrir Google Calendar
          const googleUrl = this.buildGoogleCalendarUrl(details);
          window.open(googleUrl, '_blank', 'noopener,noreferrer');
        }
      },
      buildCalendarEventDetails(session) {
        const start = new Date(session.datetime);
        const end = new Date(start.getTime() + (session.durationMinutes || 90) * 60000);
        const title = `Badminton - ${session.club}`;
        const location = session.club;
        const participants = Array.isArray(session.participants) ? session.participants : [];
        const priceLabel = Number(session.pricePerParticipant) === 0 ? 'Gratuit' : `${session.pricePerParticipant} EUR`;
        const description = [
          `Niveau : ${session.level || 'Non pr√©cis√©'}`,
          `Organisateur : ${session.organizer}`,
          `Tarif : ${priceLabel}`,
          `Dur√©e : ${this.formatDuration(session.durationMinutes)}`,
          `Participants : ${session.capacity}`,
          '',
          'https://badly.ovh'
        ].join('\n');

        return { title, location, description, start, end, sessionId: session.id };
      },
      buildGoogleCalendarUrl(details) {
        const fmt = (d) => d.toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '');
        const params = new URLSearchParams({
          action: 'TEMPLATE',
          text: details.title,
          dates: `${fmt(details.start)}/${fmt(details.end)}`,
          details: details.description,
          location: details.location
        });
        return `https://calendar.google.com/calendar/render?${params.toString()}`;
      },
      generateIcsContent(details) {
        const foldLine = (line) => {
          const bytes = new TextEncoder().encode(line);
          if (bytes.length <= 75) return line;
          const parts = [];
          let current = '';
          for (const char of line) {
            const test = current + char;
            if (new TextEncoder().encode(test).length > 75) {
              parts.push(current);
              current = ' ' + char;
            } else {
              current = test;
            }
          }
          if (current) parts.push(current);
          return parts.join('\r\n');
        };
        const escapeIcs = (text) => text.replace(/\\/g, '\\\\').replace(/;/g, '\\;').replace(/,/g, '\\,').replace(/\n/g, '\\n');
        const fmt = (d) => d.toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '');
        const now = new Date();
        const lines = [
          'BEGIN:VCALENDAR',
          'VERSION:2.0',
          'PRODID:-//Badly//badly.ovh//FR',
          'CALSCALE:GREGORIAN',
          'METHOD:PUBLISH',
          'BEGIN:VEVENT',
          foldLine(`UID:${details.sessionId}@badly.ovh`),
          foldLine(`DTSTAMP:${fmt(now)}`),
          foldLine(`DTSTART:${fmt(details.start)}`),
          foldLine(`DTEND:${fmt(details.end)}`),
          foldLine(`SUMMARY:${escapeIcs(details.title)}`),
          foldLine(`DESCRIPTION:${escapeIcs(details.description)}`),
          foldLine(`LOCATION:${escapeIcs(details.location)}`),
          'END:VEVENT',
          'END:VCALENDAR'
        ];
        return lines.join('\r\n');
      },
      downloadIcsFile(details) {
        const content = this.generateIcsContent(details);
        const blob = new Blob([content], { type: 'text/calendar;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `badminton-${details.sessionId}.ics`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      },
      async unsubscribeFromPush() {
        try {
          if (this.state.pushSubscription) {
            await this.state.pushSubscription.unsubscribe();
            await this.api('/unsubscribePush', { 
              endpoint: this.state.pushSubscription.endpoint 
            });
            this.state.pushSubscription = null;
            console.log('D√©sabonn√© des notifications push');
          }
        } catch (error) {
          console.error('Erreur lors du d√©sabonnement:', error);
        }
      }
    };

    document.addEventListener('DOMContentLoaded', () => {
      app.init();
      // Afficher "Badly-dev" dans le titre si l'URL contient "dev"
      if (window.location.href.includes('dev')) {
        document.title = 'Badly-dev';
      }
    });
  </script>
</body>
</html>
